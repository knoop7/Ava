# Ava 技术文档

## 项目概述

Ava 是一款基于 ESPHome 协议的 Android 语音助手应用，可将 Android 设备转变为智能家居中控屏。

- **最低支持**: Android 7.0 (API 24)
- **目标版本**: Android 16 (API 36)
- **架构支持**: arm64-v8a, armeabi-v7a (32/64位)
- **开发语言**: Kotlin + C++ (JNI)

---

## 项目结构

```
Ava/
├── app/                          # 主应用模块
│   └── src/main/java/com/example/ava/
│       ├── audio/                # 音频输入
│       ├── bluetooth/            # 蓝牙在场检测
│       ├── camera/               # 摄像头拍照/录像
│       ├── esphome/              # ESPHome 协议实现
│       │   ├── entities/         # 实体类型定义
│       │   └── voicesatellite/   # 语音卫星核心
│       ├── microwakeword/        # 唤醒词检测
│       ├── notifications/        # 通知场景
│       ├── nsd/                  # 网络服务发现
│       ├── players/              # 音频播放器
│       ├── sensor/               # 环境传感器
│       ├── sensors/              # 诊断传感器
│       ├── server/               # TCP 服务器
│       ├── services/             # Android 服务
│       ├── settings/             # 设置存储
│       ├── ui/                   # Jetpack Compose UI
│       ├── update/               # 自动更新
│       ├── utils/                # 工具类
│       ├── wakelocks/            # 唤醒锁
│       └── weather/              # 天气服务
├── esphomeproto/                 # ESPHome Protobuf 协议
├── microfeatures/                # C++ 音频前端处理
│   └── src/main/cpp/
│       ├── MicroFrontend.cpp     # 音频特征提取
│       ├── kissfft/              # FFT 库
│       └── tensorflow/           # TensorFlow Lite
└── gradle/                       # Gradle 配置
```

---

## 核心模块

### 1. ESPHome 协议层

#### EspHomeDevice.kt
ESPHome 设备基类，实现协议通信：

```kotlin
abstract class EspHomeDevice(
    coroutineContext: CoroutineContext,
    name: String,
    port: Int = 6053,
    entities: Iterable<Entity>
)
```

- 管理 TCP 服务器连接
- 处理 Protobuf 消息收发
- 维护实体状态订阅

#### 支持的实体类型

| 实体类型 | 文件 | 用途 |
|---------|------|------|
| MediaPlayerEntity | 媒体播放器控制 |
| CameraEntity | 摄像头图像/视频 |
| SwitchEntity | 开关控制 |
| SensorEntity | 数值传感器 |
| BinarySensorEntity | 二元传感器 |
| ButtonEntity | 按钮触发 |
| NumberEntity | 数值调节 |
| SelectEntity | 选项选择 |
| TextEntity | 文本输入 |
| TextSensorEntity | 文本传感器 |
| ServiceEntity | 服务调用 |

### 2. 语音卫星核心

#### VoiceSatellite.kt
语音卫星主类，协调所有功能：

- 唤醒词检测与响应
- 音频流传输
- TTS 播放
- 实体注册与管理
- 传感器数据采集

#### VoiceSatelliteAudioInput.kt
音频输入处理：

- 16kHz 采样率
- 唤醒词/停止词检测
- 音频流控制

#### VoiceSatellitePlayer.kt
音频播放管理：

- TTS 播放器
- 媒体播放器
- 唤醒提示音
- 音量控制

### 3. 唤醒词检测

#### MicroFrontend.cpp (C++)
音频特征提取，基于 TensorFlow Lite Micro Frontend：

```cpp
class MicroFrontend {
    FrontendConfig frontend_config;
    FrontendState frontend_state;
public:
    FrontendOutput ProcessSamples(int16_t *samples, size_t *num_samples_read);
};
```

配置参数：
- 窗口大小: 30ms
- 步进: 10ms
- 滤波器通道: 40
- 频率范围: 125Hz - 7500Hz
- PCAN 增益控制
- 对数缩放

#### WakeWordDetector.kt
唤醒词检测器：

```kotlin
class WakeWordDetector(wakeWordProvider: WakeWordProvider) {
    fun detect(audio: ByteBuffer): List<DetectionResult>
    fun setActiveWakeWords(wakeWordIds: List<String>)
}
```

#### MicroWakeWord.kt
TensorFlow Lite 模型推理：

- 加载 .tflite 模型
- 滑动窗口概率计算
- 阈值判断

### 4. 蓝牙在场检测

#### BluetoothPresenceManager.kt
蓝牙设备追踪与在场检测：

```kotlin
class BluetoothPresenceManager {
    val trackedDevices: StateFlow<Map<String, TrackedDevice>>
    val devicePresence: StateFlow<Map<String, Boolean>>
    
    fun onDeviceScanned(address: String, rssi: Int)
    fun checkTimeouts()
}
```

功能：
- BLE 扫描与设备追踪
- RSSI 阈值判断
- 离场延迟检测
- 经典蓝牙 SDP 查询
- BLE 广播（让 iOS 设备检测）

配置参数：
- RSSI 阈值: -120 ~ 0 dBm
- 离场延迟: 5 ~ 3600 秒
- 扫描间隔: 6 秒

### 5. 摄像头模块

#### CameraCapture.kt
静态图片拍摄：

```kotlin
class CameraCapture(context: Context) {
    suspend fun capturePhoto(
        useFrontCamera: Boolean = false,
        targetSize: Int = 500
    ): ByteArray?
}
```

- 基于 CameraX
- 支持前后摄像头
- 自动旋转校正
- 正方形裁剪与缩放

#### VideoCapture.kt
实时视频流：

- 可调帧率 (1-15 fps)
- 可调分辨率 (240-720p)
- JPEG 帧输出

### 6. 传感器模块

#### EnvironmentSensorManager.kt
环境传感器管理：

```kotlin
class EnvironmentSensorManager(context: Context) {
    val lightLevel: StateFlow<Float>      // 光照 (lux)
    val magneticField: StateFlow<Float>   // 磁场 (μT)
    val proximity: StateFlow<Float>       // 接近距离
}
```

#### DiagnosticSensorManager.kt
诊断信息采集：

- WiFi 信号强度
- 设备 IP 地址
- 存储空间
- 内存使用
- 电池电量/电压
- 充电状态
- 运行时间

### 7. 服务层

| 服务 | 功能 |
|------|------|
| VoiceSatelliteService | 主服务，管理语音卫星生命周期 |
| DreamClockService | 梦幻时钟悬浮窗 |
| WeatherOverlayService | 天气信息悬浮窗 |
| VinylCoverService | 黑胶唱片封面悬浮窗 |
| FloatingWindowService | 对话字幕悬浮窗 |
| NotificationOverlayService | 通知场景全屏覆盖 |
| ScreensaverService | 图片屏保 |
| ScreensaverWebViewService | 网页屏保 |
| WakeAnimationService | 唤醒动画 |
| WebViewService | 内嵌浏览器 |

### 8. 网络服务发现

#### VoiceSatelliteNsd.kt
mDNS 服务注册：

```kotlin
fun registerVoiceSatelliteNsd(
    context: Context,
    name: String,
    port: Int,
    macAddress: String
): NsdRegistration
```

服务类型: `_esphomelib._tcp`

属性：
- version: 2025.9.0
- mac: 设备 MAC 地址
- board: host
- platform: HOST
- network: wifi

### 9. 自动更新

#### AppUpdater.kt
应用自动更新：

```kotlin
object AppUpdater {
    suspend fun checkUpdate(context: Context): UpdateInfo?
    fun downloadAndInstall(context: Context, updateInfo: UpdateInfo)
}
```

- 从 GitHub 检查版本
- 下载 APK
- 自动安装

### 10. 音频处理增强

#### GpioAecController.kt
硬件回声消除控制：

```kotlin
object GpioAecController {
    fun activateAEC(): Boolean      // 激活回声消除
    fun activateBeamforming(): Boolean  // 激活波束成形
}
```

支持设备：
- Ococci A64 (GPIO116)
- Holi 平台 (GPIO144)

---

## 设置存储

使用 Jetpack DataStore 持久化设置：

| 设置文件 | 内容 |
|---------|------|
| VoiceSatelliteSettings | 卫星名称、端口、MAC 地址 |
| MicrophoneSettings | 唤醒词、停止词、静音状态 |
| PlayerSettings | 音量、唤醒音、悬浮窗开关 |
| ExperimentalSettings | 摄像头、传感器、诊断功能 |
| NotificationSettings | 场景显示时长、自定义场景 URL |
| ScreensaverSettings | 屏保开关、URL、超时 |
| BrowserSettings | 高级控制、JS/CSS 注入 |

---

## 依赖库

### 核心依赖
- Kotlin Coroutines
- Jetpack Compose
- Protobuf
- TensorFlow Lite

### 媒体
- ExoPlayer (Media3)
- CameraX

### 其他
- Shizuku (免 Root 权限)
- Gson
- DataStore

---

## 构建配置

```kotlin
android {
    compileSdk = 36
    minSdk = 24
    targetSdk = 36
    
    ndk {
        abiFilters.add("arm64-v8a")
        abiFilters.add("armeabi-v7a")
    }
}
```

---

## 通信协议

### ESPHome Native API

基于 Protobuf 的二进制协议，端口默认 6053。

消息类型：
- HelloRequest/Response
- ConnectRequest/Response
- DeviceInfoRequest/Response
- ListEntitiesRequest/Response
- SubscribeStatesRequest
- VoiceAssistantRequest/Response
- VoiceAssistantAudio

### 音频格式

- 采样率: 16000 Hz
- 位深: 16-bit
- 通道: 单声道
- 编码: PCM

---

## 权限要求

### 必需权限
```xml
<uses-permission android:name="android.permission.RECORD_AUDIO" />
<uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW" />
<uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
<uses-permission android:name="android.permission.INTERNET" />
```

### 可选权限
```xml
<uses-permission android:name="android.permission.CAMERA" />
<uses-permission android:name="android.permission.BLUETOOTH" />
<uses-permission android:name="android.permission.BLUETOOTH_SCAN" />
<uses-permission android:name="android.permission.BLUETOOTH_CONNECT" />
<uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
<uses-permission android:name="android.permission.WRITE_SETTINGS" />
```

---

## 国际化支持

### 语言自适应检测

应用使用多重判断检测用户语言环境：

```kotlin
private fun isChinese(): Boolean {
    val locale = java.util.Locale.getDefault()
    val language = locale.language.lowercase()
    val country = locale.country.uppercase()
    val timezone = java.util.TimeZone.getDefault().id
    return language.startsWith("zh") || 
        country in listOf("CN", "TW", "HK", "MO") ||
        timezone.startsWith("Asia/Shanghai") || 
        timezone.startsWith("Asia/Chongqing") ||
        timezone.startsWith("Asia/Hong_Kong") ||
        timezone.startsWith("Asia/Taipei")
}
```

### 自适应内容

| 功能 | 中文环境 | 英文环境 |
|------|---------|---------|
| 小米画报日期 | 2025年1月9日 星期四 | Thursday, January 9, 2025 |
| 小米画报古诗词 | 显示 | 隐藏 |
| 天气状况 | 晴/多云/雨 | Sunny/Cloudy/Rain |
| 天气卡片标签 | 湿度/空气/气压 | Humidity/Air/Pressure |
| 风向 | 北风/东北风 | N/NE |
| 场景JSON | scenes_zh.json | scenes_en.json |
| 天气功能开关 | 显示 | 隐藏 |

### 场景JSON网络加载

```kotlin
private const val SCENES_URL_ZH = "https://ghfast.top/.../scenes_zh.json"
private const val SCENES_URL_EN = "https://ghfast.top/.../scenes_en.json"

fun loadFromAssets(context: Context, onComplete: (() -> Unit)? = null) {
    loadFromNetwork(onComplete)
}
```

---

## 屏保系统

### 小米画报 (xiaomi_wallpaper.html)

WebView 屏保，模仿小米画报风格：

- 全屏时钟显示
- 日期和星期
- 古诗词展示（中文环境）
- 语言自适应

### 屏保控制器 (ScreensaverController.kt)

统一管理屏保生命周期：

- 图片屏保 (ScreensaverService)
- 网页屏保 (ScreensaverWebViewService)
- 超时自动启动
- 触摸唤醒

---

## WebView 稳定性

### 渲染器崩溃处理

```kotlin
override fun onRenderProcessGone(
    view: WebView?,
    detail: RenderProcessGoneDetail?
): Boolean {
    // 销毁旧 WebView
    webView?.let { wv ->
        (wv.parent as? ViewGroup)?.removeView(wv)
        wv.destroy()
    }
    // 延迟重建
    Handler(Looper.getMainLooper()).postDelayed({
        recreateWebView()
    }, 500)
    return true
}
```

### 正确的销毁顺序

```kotlin
private fun hideWebView() {
    webView?.let { wv ->
        wv.stopLoading()
        wv.onPause()
        wv.pauseTimers()
        wv.loadUrl("about:blank")
        (wv.parent as? ViewGroup)?.removeView(wv)
        wv.destroy()
    }
}
```

### 渲染器优先级

```kotlin
if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
    webView.setRendererPriorityPolicy(
        WebView.RENDERER_PRIORITY_IMPORTANT, 
        false
    )
}
```

---

## 通知场景系统

### SceneData.kt

场景数据管理：

```kotlin
data class NotificationScene(
    val id: String,
    val icon: String,
    val iconColor: String,
    val title: String,
    val desc: String,
    val subDesc: String,
    val themeColors: List<String>,
    val beamColor: String,
    val dividerColor: String,
    val dotColor: String,
    val animation: String
)
```

### NotificationOverlayService.kt

全屏通知覆盖：

- 极光动画背景
- 图标日出动画
- 自定义主题颜色
- 提示音播放

---

## 天气服务

### WeatherService.kt

中国天气网 API 集成：

- 城市坐标查询（百度地图 API）
- 实时天气数据
- 空气质量指数
- 风向风速

### WeatherOverlayService.kt

天气悬浮窗：

- 温度显示
- 天气状况图标
- 6 格信息卡片
- 粒子动画效果

---

## 音量控制

### VolumeControlService.kt

系统音量管理：

- 媒体音量
- 通知音量
- 闹钟音量
- 静音控制

---

## 版本历史

当前版本: 0.1.6

---

## 相关链接

- 原项目: https://github.com/brownard/Ava
- 本项目: https://github.com/knoop7/Ava
- ESPHome: https://esphome.io/
- Home Assistant: https://www.home-assistant.io/
