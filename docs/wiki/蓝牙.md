# 蓝牙

Ava 支持蓝牙在场检测和蓝牙中继器功能。

---

## 功能概述

### 蓝牙在场检测

- 检测手机、手环等蓝牙设备是否在附近
- 用于判断用户是否在家
- 触发自动化场景

### 蓝牙中继器（重磅功能）

Ava 可以作为蓝牙中继器，将蓝牙设备信息转发到 Home Assistant。

**特点：**
- 支持 5 个设备卡槽
- 与 Home Assistant Bluetooth 集成原生集成
- 扩展蓝牙覆盖范围

> **注意：** 蓝牙中继器功能的源代码未开源，仅在发布版本中提供。其他功能的代码均可在 GitHub 上查看。

---

## 工作原理

### BLE 扫描

Ava 使用低功耗蓝牙（BLE）扫描来检测设备：

1. 定期扫描附近的蓝牙设备
2. 根据 MAC 地址匹配目标设备
3. 更新在场状态到 Home Assistant

### 在场判断

| 状态 | 条件 |
|------|------|
| 在家 | 检测到目标设备 |
| 离家 | 连续多次扫描未检测到设备 |

---

## 设置

进入 **设置** -> **蓝牙**

### 在场检测设置

| 设置项 | 说明 | 默认值 |
|--------|------|--------|
| 启用蓝牙检测 | 开启蓝牙在场检测 | 关闭 |
| 目标设备 | 要检测的蓝牙设备 MAC 地址 | 空 |
| 扫描间隔 | 扫描频率 | 30秒 |

### 蓝牙中继器设置

| 设置项 | 说明 |
|--------|------|
| 启用中继器 | 开启蓝牙中继功能 |
| 设备卡槽 1-5 | 配置要中继的蓝牙设备 |

---

## 权限要求

蓝牙功能需要以下权限：

| 权限 | 说明 |
|------|------|
| BLUETOOTH | 蓝牙基本权限 |
| BLUETOOTH_SCAN | 蓝牙扫描权限（Android 12+） |
| ACCESS_FINE_LOCATION | 位置权限（蓝牙扫描需要） |

---

## Home Assistant 集成

### 在场实体

```
binary_sensor.your_device_name_bluetooth_presence
```

### 蓝牙中继器集成

蓝牙中继器与 Home Assistant 的 Bluetooth 集成原生集成：

1. 在 HA 中添加 Bluetooth 集成
2. Ava 会自动被发现为蓝牙代理
3. 通过 Ava 中继的蓝牙设备会出现在 HA 中

**支持的设备类型：**
- 蓝牙温湿度计
- 蓝牙体重秤
- 蓝牙植物传感器
- 其他 BLE 设备

### 自动化示例

**回家时开灯：**
```yaml
automation:
  - alias: "回家开灯"
    trigger:
      - platform: state
        entity_id: binary_sensor.ava_bluetooth_presence
        to: "on"
    action:
      - service: light.turn_on
        target:
          entity_id: light.living_room
```

**离家时关闭所有设备：**
```yaml
automation:
  - alias: "离家关闭"
    trigger:
      - platform: state
        entity_id: binary_sensor.ava_bluetooth_presence
        to: "off"
        for:
          minutes: 5
    action:
      - service: homeassistant.turn_off
        target:
          entity_id: group.all_lights
```

---

## 常见问题

### 蓝牙检测不准确？

1. 确保目标设备蓝牙已开启
2. 检查 MAC 地址是否正确
3. 调整扫描间隔
4. 确保位置权限已授予

### 耗电量大？

1. 增加扫描间隔（如 60 秒）
2. 仅在需要时启用蓝牙检测

### 无法扫描到设备？

1. 检查蓝牙权限
2. 检查位置权限（Android 要求）
3. 确保目标设备可被发现

---

*返回 [首页](Home.md)*
