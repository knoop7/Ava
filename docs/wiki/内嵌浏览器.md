# 内嵌浏览器

内嵌浏览器让你可以在 Ava 中显示网页，如 Home Assistant 仪表盘。

---

## 概述

内嵌浏览器是一个全屏 WebView，可以显示任何网页内容。

**主要用途：**
- 显示 Home Assistant 仪表盘
- 显示自定义控制面板
- 显示信息网站

---

## 功能特点

### 基础功能

| 功能 | 说明 |
|------|------|
| 全屏显示 | 网页占满整个屏幕 |
| 下拉刷新 | 下拉页面可刷新 |
| JavaScript | 完整支持 JS |
| 本地存储 | 支持 LocalStorage |

### 高级功能

| 功能 | 说明 |
|------|------|
| 自定义 CSS | 注入自定义样式 |
| 自定义 JS | 注入自定义脚本 |
| 渲染模式 | 硬件/软件渲染切换 |

---

## 设置

### 如何开启

通过 Home Assistant 服务打开浏览器：

```yaml
service: esphome.your_device_name_ha_remote_url
data:
  url: "http://your-ha-address:8123/lovelace/0"
```

### 设置选项

进入 **设置** → **浏览器**

| 设置项 | 说明 | 默认值 |
|--------|------|--------|
| 高级控制 | 启用高级浏览器控制功能 | 关闭 |
| 下拉刷新 | 允许下拉刷新页面 | 开启 |
| 初始缩放 | 页面初始缩放比例 (0-500, 0=自动) | 0 |
| 字体大小 | 页面字体大小百分比 (50-300) | 100 |
| 触摸启用 | 允许触摸交互 | 开启 |
| 拖动启用 | 允许拖动操作 | 开启 |
| 渲染模式 | 硬件/软件渲染 | 硬件 |
| 设置按钮 | 显示设置按钮 | 关闭 |
| 返回键隐藏 | 按返回键隐藏浏览器 | 开启 |

### 渲染模式

| 模式 | 说明 | 适用场景 |
|------|------|----------|
| 硬件 (Hardware) | 使用 GPU 渲染，性能好 | 大多数设备 |
| 软件 (Software) | 使用 CPU 渲染，兼容性好 | 老旧设备或渲染问题 |

---

## Home Assistant 仪表盘

### 推荐配置

为 Ava 创建专用的仪表盘视图：

```yaml
# configuration.yaml
lovelace:
  mode: yaml
  dashboards:
    ava-dashboard:
      mode: yaml
      filename: ava_dashboard.yaml
      title: Ava
      icon: mdi:tablet
      show_in_sidebar: false
```

### 隐藏侧边栏

使用自定义 CSS 隐藏 HA 的侧边栏和顶栏：

```css
/* 隐藏侧边栏 */
ha-sidebar { display: none !important; }

/* 隐藏顶栏 */
.header { display: none !important; }

/* 全屏内容 */
home-assistant { --app-drawer-width: 0px; }
```

### 自动登录

使用长期访问令牌实现自动登录：

1. 在 HA 中创建长期访问令牌
2. 在 URL 中添加令牌参数

---

## 高级控制

开启高级控制后，可以通过 Home Assistant 服务远程控制浏览器。

### 支持的操作

- 打开指定 URL
- 关闭浏览器
- 刷新页面
- 前进/后退

### 注意事项

开启高级控制会重启语音卫星服务。

---

## Home Assistant 控制

浏览器通过 `ha_remote_url` 文本实体控制，通过 `browser_command` 文本实体执行命令。

### 打开网页

```yaml
service: text.set_value
target:
  entity_id: text.your_device_name_ha_remote_url
data:
  value: "http://your-ha-address:8123/lovelace/0"
```

### 关闭浏览器

```yaml
service: text.set_value
target:
  entity_id: text.your_device_name_ha_remote_url
data:
  value: ""
```

### 执行命令

命令使用 JSON 格式：

```yaml
service: text.set_value
target:
  entity_id: text.your_device_name_browser_command
data:
  value: '{"reload": true}'
```

### 支持的命令

| 命令 | 格式 | 说明 |
|------|------|------|
| 刷新页面 | `{"reload": true}` | 重新加载当前页面 |
| 清除缓存 | `{"clearCache": true}` | 清除浏览器缓存 |
| 打开设置 | `{"settings": true}` | 打开 Ava 设置页面 |
| 设置亮度 | `{"brightness": 128}` | 设置屏幕亮度 (0-255) |
| 执行 JS | `{"eval": "alert('hello')"}` | 执行 JavaScript 代码 |
| 清除注入 | `{"eval": ""}` | 清除注入的效果 |

---

## 使用 AI 生成动画效果

你可以使用 Gemini AI 工具生成自定义的动画效果：

https://gemini.google.com/gem/ee3cb858f9d0

告诉 AI 你想要的效果（如“樱花飘落”“下雪”“繁星”等），AI 会生成可用的 JSON 命令。

### 示例：樱花动画

```yaml
service: text.set_value
target:
  entity_id: text.your_device_name_browser_command
data:
  value: '{"eval": "!function(d,b,c,s){d=document,b=d.body,c=d.createElement(\\\"div\\\"),s=d.createElement(\\\"style\\\"),c.style.cssText=\\\"position:fixed;top:0;left:0;width:100%;height:100%;z-index:9999;overflow:hidden;pointer-events:none\\\",s.textContent=\\\".s{position:absolute;top:-10%;background:linear-gradient(135deg,#fff 20%,#ffb7c5 100%);border-radius:100% 0 120% 0;box-shadow:1px 1px 2px rgba(0,0,0,.1);animation:f linear infinite,w ease-in-out infinite alternate}@keyframes f{0%{opacity:0;transform:translateY(0) rotateX(0) rotateZ(0)}20%{opacity:1}100%{opacity:0;transform:translateY(110vh) rotateX(360deg) rotateZ(720deg)}}@keyframes w{0%{margin-left:-50px}100%{margin-left:50px}}\\\",d.head.appendChild(s),b.appendChild(c),setInterval(function(p,w,t){p=d.createElement(\\\"div\\\"),w=Math.random()*20+8,t=Math.random()*10+6,p.className=\\\"s\\\",p.style.cssText=\\\"left:\\\"+Math.random()*100+\\\"%%;width:\\\"+w+\\\"px;height:\\\"+w*1.4+\\\"px;animation-duration:\\\"+t+\\\"s,\\\"+(Math.random()*4+3)+\\\"s;animation-delay:-\\\"+Math.random()*8+\\\"s\\\",c.appendChild(p),setTimeout(function(){c.removeChild(p)},t*1e3)},100)}()"}'
```

### 清除动画效果

```yaml
service: text.set_value
target:
  entity_id: text.your_device_name_browser_command
data:
  value: '{"eval": ""}'
```

---

## WebView 稳定性

### 渲染器崩溃处理

Ava 实现了 WebView 渲染器崩溃自动恢复：

1. 检测到渲染器崩溃
2. 销毁旧的 WebView
3. 延迟 500ms 后重建
4. 重新加载之前的 URL

### 正确的销毁顺序

为避免崩溃，WebView 销毁遵循以下顺序：

1. `stopLoading()` - 停止加载
2. `onPause()` - 暂停
3. `pauseTimers()` - 暂停定时器
4. `loadUrl("about:blank")` - 加载空白页
5. `removeView()` - 从父容器移除
6. `destroy()` - 销毁

---

## 常见问题

### 网页显示空白？

1. 检查 URL 是否正确
2. 检查网络连接
3. 尝试切换渲染模式
4. 检查 HA 是否可访问

### 网页加载慢？

1. 检查网络速度
2. 简化仪表盘内容
3. 减少动画效果

### 触摸不响应？

1. 检查悬浮窗权限
2. 尝试重启服务
3. 检查是否有其他悬浮窗遮挡

### 如何返回主界面？

1. 使用 Home Assistant 服务关闭浏览器
2. 或在 HA 仪表盘中添加返回按钮

---

*返回 [首页](Home.md)*
