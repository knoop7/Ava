# 摄像头

Ava 的摄像头功能提供高性能视频流传输到 Home Assistant，采用全新设计的架构，性能优于 WallPanel 和 Fully Kiosk 等替代方案。

---

## 为什么 Ava 摄像头不同

### 与替代方案对比

| 特性 | Ava | WallPanel | Fully Kiosk |
|------|-----|-----------|-------------|
| 内存占用 | 100-150 MB | 150-200 MB | 200-300 MB |
| 视频延迟 | 低 | 高 | 中等 |
| 丢帧情况 | 极少 | 频繁 | 偶尔 |
| 架构 | 原生 ESPHome 协议 | HTTP MJPEG | HTTP MJPEG |
| 集成方式 | 原生 HA 实体 | 手动配置 | 手动配置 |

### 技术优势

**1. 原生 ESPHome 协议**
- 通过 ESPHome 协议直接二进制流传输
- 无 HTTP 协议开销
- 分块传输优化性能

**2. 智能帧管理**
- 网络繁忙时自动丢帧
- 防止缓冲区溢出和延迟累积
- `isSending` 标志确保帧不重叠

**3. 高效内存使用**
- 使用 Kotlin Flow 响应式流
- 单一重放缓存防止内存膨胀
- 分块大小优化为 1024 字节

**4. 原创架构设计**
- 从零开始为 ESPHome 集成构建
- 不是现有方案的封装
- 专为 Home Assistant 设计

---

## 功能

### 静态照片

按需捕获单张照片。

**技术实现：**
- JPEG 压缩，可配置质量
- 根据设备方向自动旋转校正
- 方形裁剪确保显示一致

### 视频流

实时 MJPEG 视频流。

**技术实现：**
- 分块二进制传输（每块 1024 字节）
- 基于 Flow 的响应式流
- 根据网络自动调整帧率

---

## 设置

进入 **设置** -> **实验性**

| 设置项 | 说明 | 默认值 |
|--------|------|--------|
| 启用摄像头 | 开启摄像头功能 | 关闭 |
| 使用前置摄像头 | 默认前置或后置 | 后置 |
| 视频帧率 | 视频流帧率 | 5 fps |
| 视频分辨率 | 视频流分辨率 | 480p |

### 帧率指南

| 帧率 | 使用场景 |
|------|----------|
| 1 fps | 监控，最低带宽 |
| 5 fps | 通用，平衡 |
| 10 fps | 需要看到运动 |
| 15 fps | 最高质量 |

### 分辨率指南

| 分辨率 | 像素 | 带宽 |
|--------|------|------|
| 240p | 320x240 | 最低 |
| 360p | 480x360 | 低 |
| 480p | 640x480 | 中等 |
| 720p | 1280x720 | 高 |

---

## Home Assistant 集成

### 摄像头实体

启用后，Home Assistant 中会出现摄像头实体：
- `camera.your_device_name`

### 仪表盘卡片

```yaml
type: picture-entity
entity: camera.your_device_name
camera_view: live
```

### 快照服务

```yaml
service: camera.snapshot
target:
  entity_id: camera.your_device_name
data:
  filename: /config/www/snapshot.jpg
```

---

## 性能技巧

### 获得最佳视频质量

1. 如果可用，使用 5G WiFi
2. 设备靠近路由器
3. 从 480p 开始，稳定后再提高

### 低带宽环境

1. 使用 1-2 fps 帧率
2. 使用 240p 或 360p 分辨率
3. 使用单张图片模式而非视频流

### 解决延迟问题

与 WallPanel 即使调整也经常显示延迟不同，Ava 的架构防止延迟累积：

1. 网络繁忙时自动丢帧
2. 无缓冲区溢出问题
3. 如果出现延迟，会快速自我修正

---

## 常见问题

### 摄像头在 HA 中不显示？

1. 检查是否已授予摄像头权限
2. 检查设置中是否启用了摄像头功能
3. 确认 Home Assistant 已连接

### 视频流卡顿？

1. 降低帧率（尝试 1-2 fps）
2. 降低分辨率（尝试 240p）
3. 检查 WiFi 信号强度
4. Ava 会自动调整，延迟应该会自我修正

### 为什么 Ava 比 WallPanel 快？

WallPanel 使用 HTTP MJPEG 流，存在：
- HTTP 协议开销
- 无智能帧管理
- 缓冲区累积问题

Ava 使用原生 ESPHome 二进制协议，具有：
- 直接二进制流传输
- 智能丢帧
- 基于 Flow 的响应式架构

---

*返回 [首页](Home.md)*
