# 传感器

Ava 可以读取设备的环境传感器数据，并将其暴露给 Home Assistant。

---

## 支持的传感器

| 传感器类型 | 说明 | 单位 |
|------------|------|------|
| 光照传感器 | 环境光照强度 | lux |
| 磁场传感器 | 磁场强度 | μT |
| 接近传感器 | 物体接近检测 | cm 或二进制 |

---

## 光照传感器

### 功能

- 测量环境光照强度
- 用于光照感应关屏功能
- 数据实时更新

### Home Assistant 实体

```
sensor.your_device_name_light_level
```

### 使用场景

**自动调节灯光：**
```yaml
automation:
  - alias: "光照自动调节"
    trigger:
      - platform: numeric_state
        entity_id: sensor.ava_light_level
        below: 50
    action:
      - service: light.turn_on
        target:
          entity_id: light.living_room
```

---

## 磁场传感器

### 功能

- 测量环境磁场强度
- 计算三轴磁场的合成值
- 可用于检测金属物体

### Home Assistant 实体

```
sensor.your_device_name_magnetic_field
```

### 技术实现

磁场强度计算公式：
```
magnitude = sqrt(x² + y² + z²)
```

---

## 接近传感器

### 功能

- 检测物体是否靠近设备
- 用于接近感应唤醒功能
- 通常用于检测人脸靠近

### Home Assistant 实体

```
binary_sensor.your_device_name_proximity
```

### 使用场景

**有人靠近时唤醒屏幕：**
```yaml
automation:
  - alias: "接近唤醒"
    trigger:
      - platform: state
        entity_id: binary_sensor.ava_proximity
        to: "on"
    action:
      - service: switch.turn_off
        target:
          entity_id: switch.ava_screensaver
```

---

## 设备能力检测

Ava 会自动检测设备是否具有这些传感器：

| 检测方法 | 说明 |
|----------|------|
| hasLightSensor | 是否有光照传感器 |
| hasMagneticSensor | 是否有磁场传感器 |
| hasProximitySensor | 是否有接近传感器 |
| hasAnySensor | 是否有任何传感器 |

如果设备没有某个传感器，相应的实体将不会创建。

---

## 技术实现

### 响应式数据流

Ava 使用 Kotlin StateFlow 实现传感器数据的响应式更新：

```kotlin
private val _lightLevel = MutableStateFlow(0f)
val lightLevel: StateFlow<Float> = _lightLevel.asStateFlow()
```

### 传感器采样率

| 传感器 | 采样率 |
|--------|--------|
| 光照 | SENSOR_DELAY_FASTEST |
| 磁场 | SENSOR_DELAY_NORMAL |
| 接近 | SENSOR_DELAY_NORMAL |

光照传感器使用最快采样率以确保光照感应关屏功能的响应速度。

---

## 常见问题

### 传感器数据不更新？

1. 检查设备是否有该传感器
2. 检查 Ava 服务是否正在运行
3. 部分设备传感器可能被系统限制

### 光照感应关屏不工作？

1. 确认设备有光照传感器
2. 检查设置中是否启用了光照感应关屏
3. 默认阈值为 2 lux

### 接近感应唤醒不工作？

1. 确认设备有接近传感器
2. 检查设置中是否启用了接近感应唤醒
3. 检查接近传感器的最大范围

---

*返回 [首页](Home.md)*
